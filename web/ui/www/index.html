<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="shortcut icon" href="/static/images/spy-black.png">
        <link rel="icon" href="/static/images/spy-black.png">

        <title>Whisper</title>

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/static/css/whisper.css" />
        <script src="/static/js/jquery.min.js"></script>
        <script src="/static/js/bootstrap.min.js" ></script>
    </head>

    <body>
        <!-- Begin page content -->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4" style="background-color: black !important;">
            <a class="navbar-brand" href="#">
                <img src="/static/images/spy-white.png" width="30" height="30" class="d-inline-block align-top" alt="">
                <b>Whisper</b>
            </a>
        </nav>

        <!-- page content -->
        <div id="login-content" class="card container" hidden="true">
            <div class="card-body">
                <br/>
                <br/> 
                <form id="login-form" class="row" action="/login" method="POST">
                    <input id="login-challenge" type="hidden" name="challenge" value=""></input>
                    <div class="col-sm-3"></div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="username" class="form-control" id="login-username" name="username" placeholder="foo@bar.com">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="login-password" name="password" placeholder="foobar">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="remember" name="remember">
                            <label class="form-check-label" for="remember">Remember me</label>
                        </div>
                        <button id="login-submit" type="submit" class="btn btn-primary">Submit</button>
                    </div>
                    <div class="col-sm-3"></div>
                </form>
            </div>
        </div>

        <div id="consent-content" class="card container" hidden="true">
            <div class="card-body">
                <br/>
                <br/>
                <form id="consent-form" action="/consent" method="POST">
                    <input id="accept-consent" type="hidden" name="accept" value="false"></input>
                    <input id="consent-challenge" type="hidden" name="challenge" value=""></input>
                    <div class="row">
                        <div class="col-sm-2"></div>
                        <div class="col-sm-8">
                            <h5>The app <a href="#">Unknown</a> wants access to your Whisper account</h5>
                        </div>
                        <div class="col-sm-2"></div>
                    </div>
                    <br/>
                    {{range .RequestedScopes}}
                        <input type="hidden" name="grant-scope" value="{{.Scope}}"/>
                        <div class="row">
                            <div class="col-sm-2"></div>
                            <div class="col-sm-8">
                                {{.Description}}
                                <a href="#consent-details-{{.Scope}}" role="button" style="float: right; cursor: pointer;" data-toggle="collapse" aria-expanded="false" aria-controls="consent-details-{{.Scope}}">
                                    <img src="static/images/info.svg"  height="20px" width="20px"/>
                                </a>
                                <div class="collapse multi-collapse" id="consent-details-{{.Scope}}">
                                    <span style="font-size: 0.7em">{{.Details}}</span>
                                </div>
                                <hr/>
                            </div>
                            <div class="col-sm-2"></div>
                        </div>
                    {{end}}
                    
                    <br/>
                    <div class="row">
                        <div class="col-sm-4"></div>
                        <div class="col-sm-2 deny">
                            <h6 ><span class="deny" id="consent-deny" onclick="acceptConsent(false);">Deny</span></h6>
                        </div>
                        <div class="col-sm-2" >
                            <button id="consent-allow" type="submit" onclick="acceptConsent(true);" class="btn btn-primary">Allow</button>
                        </div>
                        <div class="col-sm-4"></div>
                    </div>
                </form>
            </div>
        </div>

        <div id="error-content" class="card container" hidden="true">
            <div class="card-body">
                <br/>
                <br/>
                <form class="row">
                        <div class="col-sm-3"></div>
                        <div class="col-sm-6">
                            <div class="jumbotron">
                                <h1 id="message">Page Unavailable</h1>
                            </div>
                        </div>
                        <div class="col-sm-3"></div>
                </form>
            </div>
        </div>

        <!-- footer content -->
        <footer hidden="true"class="footer">
            <div class="container">
                <div hidden="true">
                    Icons made by 
                    <a href="https://www.freepik.com/" title="Freepik">Freepik</a> from 
                    <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by 
                    <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>
                </div>
            </div>
        </footer>
        <script>
            window.onload = function() {
                var action = window.location.pathname.replace("/", "")
                if (action != "login" && action != "consent") {
                    action = "error"
                }
                setupControl(action)
                setupConsentForm()
            }

            function setupConsentForm() {
                buttons = [{id: "consent-allow", value: "true"}, {id: "consent-deny", value: "false"}]
                for (i = 0; i < buttons.length; i++) {
                    button = buttons[i]
                    document.getElementById(button.id).addEventListener("click", function(value){
                        return function(ev) {
                            event.preventDefault()
                            document.getElementById("accept-consent").value = value
                            document.getElementById("consent-form").submit();
                        }
                    }(button.value))
                }
            }

            function setupControl(action) {
                var params = new URLSearchParams(window.location.search)
                var control = getControl(action)
                control.element.hidden = false
                control.challengeElement.value = params.get(action+"_challenge")
            }

            function getControl(id) {
                return {
                    matcher: new RegExp(id),
                    element: document.getElementById(id+"-content"),
                    challengeElement: document.getElementById(id+"-challenge")
                }
            }

        </script>
    </body>
</html>